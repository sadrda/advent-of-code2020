this is ugly code written under time pressure
